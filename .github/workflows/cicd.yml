name: Go Deployment on EC2 instance

on: 
    push:
        branches:
            - deploy-to-ec2

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Source
              uses: actions/checkout@v4
            - name: Create .env file
              run: echo "PORT=${{secrets.PORT}}" >> .env
            - name: Login into Docker Hub
              run: docker login -u ${{secrets.DOCKER_USERNAME}} -p $${{secrets.DOCKER_PASSWORD}}
            - name: Build docker image
              run: docker build -t   atharvamhaske/go-ec2 .          
            - name: Push image to docker hub
              run: docker push atharvamhaske/go-ec2:latest 
              
    deploy: 
        needs: build
        runs-on: self-hosted
        steps:
            - name: Pull Docker image
              run: docker pull atharvamhaske/go-ec2:latest
            - name: Delete old container
              run: docker rm -f goapp-container  
            - name: Run docker container   
              run: docker run -d -t 8080:8080 --name goapp-container atharvamhaske/go-ec2:latest     